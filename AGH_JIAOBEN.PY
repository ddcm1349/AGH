#!/usr/bin/env python3  # Python3è§£é‡Šå™¨å£°æ˜
# -*- coding: utf-8 -*-  # UTF-8ç¼–ç ï¼ˆæ”¯æŒä¸­æ–‡æ³¨é‡Š/æ—¥å¿—ï¼Œé¿å…ä¹±ç ï¼‰
"""
AGHè§„åˆ™åˆå¹¶å»é‡å·¥å…· | å…¨åŠŸèƒ½è‡ªåŠ¨åŒ–ç‰ˆ
ğŸ“Š ç»Ÿè®¡ç»´åº¦ï¼šé»‘/ç™½/å…¶ä»–è§„åˆ™ç²¾å‡†ç»Ÿè®¡ï¼Œæ€»æ•°å®Œå…¨åŒ¹é…
ğŸ“ è®¢é˜…é…ç½®ï¼šè§„åˆ™æº+è‡ªæœ‰è®¢é˜…åœ°å€ï¼Œæ³¨é‡Šåºå·3ä¸“å±å±•ç¤º
âœ‚ï¸ å»é‡é€»è¾‘ï¼šæºå†…å»é‡+è·¨æºå…¨å±€å»é‡ï¼Œå…¨ç¨‹ä¿ç•™è§„åˆ™é¡ºåº
ğŸŒ ç½‘ç»œé€‚é…ï¼šå¸¦é‡è¯•æœºåˆ¶çš„ç½‘ç»œè¯·æ±‚ï¼ŒæŠ—æ³¢åŠ¨æ‹‰å–æ›´ç¨³å®š
ğŸ“ æ³¨é‡Šæ ¼å¼ï¼šè‡ªå®šä¹‰è§„èŒƒæ³¨é‡Šï¼Œè§„åˆ™æ–‡ä»¶å†…ç»Ÿè®¡ä¿¡æ¯å®Œæ•´
ğŸ–¥ï¸ æ—¥å¿—è¾“å‡ºï¼šGH Actionsæ—¥å¿—å®Œæ•´æ‰“å°ï¼Œå…³é”®ç»Ÿè®¡ä¸€é”®æŸ¥çœ‹
â° æ—¶é—´åŒæ­¥ï¼šç”Ÿæˆæ—¶é—´è‡ªåŠ¨è½¬æ¢åŒ—äº¬æ—¶é—´ï¼Œæ— æ—¶åŒºåå·®
"""


# â€”â€” æ¨¡å—å¯¼å…¥åŒº â€”â€”
import requests                          # å‘é€ç½‘ç»œè¯·æ±‚ï¼Œæ‹‰å–è¿œç¨‹è§„åˆ™æ–‡ä»¶
from datetime import datetime, timedelta # æ—¶é—´å¤„ç†ï¼ŒUTCè½¬åŒ—äº¬æ—¶é—´/ç”Ÿæˆæ—¥å¿—æ—¶é—´
from requests.adapters import HTTPAdapter # é…ç½®requestsè¯·æ±‚é€‚é…å™¨ï¼Œå®ç°é‡è¯•æŒ‚è½½
from urllib3.util.retry import Retry     # å®šä¹‰ç½‘ç»œè¯·æ±‚é‡è¯•ç­–ç•¥ï¼Œè§£å†³ä¸´æ—¶ç½‘ç»œæ³¢åŠ¨


# â€”â€” æ ¸å¿ƒé…ç½®åŒº â€”â€”
# å¾…åˆå¹¶çš„è¿œç¨‹AGHè§„åˆ™æºåœ°å€ï¼ˆä¸ä¸‹æ–¹åç§°ä¸€ä¸€å¯¹åº”ï¼Œå¯æŒ‰éœ€å¢åˆ ï¼‰
AGH_RULE_URLS = [
     "https://adrules.top/dns.txt",
     "https://anti-ad.net/easylist.txt"
]
# è§„åˆ™æºåç§°ï¼ˆç”¨äºæ—¥å¿—æ‰“å°ã€è§„åˆ™æ–‡ä»¶æ³¨é‡Šå±•ç¤ºï¼Œæ–¹ä¾¿æº¯æºï¼‰
AGH_RULE_NAMES = [
    "AdRules",
    "anti-ad"
]
AGH_OUTPUT_FILE = "adguard_rules.txt"    # åˆå¹¶å»é‡åç”Ÿæˆçš„æœ¬åœ°è§„åˆ™æ–‡ä»¶å
SUBSCRIBE_URL = "https://ddcm1349.github.io/AGH/adguard_rules.txt"  # è‡ªæœ‰è§„åˆ™è®¢é˜…åœ°å€
TIMEOUT = 30                             # ç½‘ç»œè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰ï¼Œè¶…æ—¶åˆ™è§¦å‘é‡è¯•


# â€”â€” å·¥å…·å‡½æ•°åŒº â€”â€”
def create_retry_session():
    """åˆ›å»ºå¸¦é‡è¯•æœºåˆ¶çš„requestsä¼šè¯
    ä½œç”¨ï¼šè§£å†³ç½‘ç»œæ³¢åŠ¨ã€æœåŠ¡å™¨ä¸´æ—¶ä¸å¯è¾¾é—®é¢˜ï¼Œè‡ªåŠ¨é‡è¯•GETè¯·æ±‚ï¼Œæå‡è§„åˆ™æ‹‰å–æˆåŠŸç‡
    è¿”å›ï¼šé…ç½®å¥½é‡è¯•ç­–ç•¥çš„ä¼šè¯å¯¹è±¡
    """
    session = requests.Session()
    # é‡è¯•ç­–ç•¥é…ç½®ï¼š3æ¬¡æœ€å¤§é‡è¯•ã€1ç§’åŸºç¡€é—´éš”ã€æŒ‡å®šå¼‚å¸¸çŠ¶æ€ç é‡è¯•
    retry = Retry(
        total=3,
        backoff_factor=1,
        status_forcelist=[429, 500, 502, 503, 504],
        allowed_methods=["GET"]
    )
    # ä¸ºHTTPS/HTTPè¯·æ±‚æŒ‚è½½é‡è¯•é€‚é…å™¨ï¼Œè®©ä¼šè¯æ‹¥æœ‰é‡è¯•èƒ½åŠ›
    session.mount("https://", HTTPAdapter(max_retries=retry))
    session.mount("http://", HTTPAdapter(max_retries=retry))
    return session


def fetch_remote_content(url, source_name):
    """æ‹‰å–è¿œç¨‹è§„åˆ™æºå†…å®¹å¹¶ç»Ÿè®¡åŸå§‹è¡Œæ•°
    å‚æ•°ï¼š
        url: è¿œç¨‹è§„åˆ™æºçš„ç½‘ç»œåœ°å€
        source_name: è§„åˆ™æºåç§°ï¼ˆç”¨äºæ—¥å¿—æ‰“å°ï¼Œæ–¹ä¾¿å®šä½æ‹‰å–ç»“æœï¼‰
    è¿”å›ï¼š
        æˆåŠŸï¼šæ‹‰å–åˆ°çš„è§„åˆ™å†…å®¹ï¼ˆå­—ç¬¦ä¸²ï¼‰ã€è§„åˆ™æ–‡ä»¶åŸå§‹æ€»è¡Œæ•°
        å¤±è´¥ï¼šç©ºå­—ç¬¦ä¸²ã€0ï¼ˆè§¦å‘å¼‚å¸¸æ—¶è¿”å›ï¼‰
    """
    try:
        print(f"\nğŸ“¥ æ‹‰å–ã€{source_name}ã€‘: {url}")
        # æ¨¡æ‹Ÿæµè§ˆå™¨è¯·æ±‚å¤´ï¼Œé¿å…éƒ¨åˆ†æœåŠ¡å™¨æ‹’ç»çˆ¬è™«ç±»å‹è¯·æ±‚
        headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0 Safari/537.36"}
        # ä½¿ç”¨å¸¦é‡è¯•çš„ä¼šè¯å‘é€GETè¯·æ±‚ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´
        resp = create_retry_session().get(url, headers=headers, timeout=TIMEOUT)
        resp.raise_for_status()  # æ ¡éªŒHTTPè¯·æ±‚çŠ¶æ€ï¼Œé200ç³»åˆ—ç›´æ¥è§¦å‘å¼‚å¸¸
        
        content = resp.text  # è·å–è§„åˆ™æ–‡ä»¶çš„æ–‡æœ¬å†…å®¹
        raw_line = len(content.splitlines())  # ç»Ÿè®¡åŸå§‹æ€»è¡Œæ•°ï¼ˆæŒ‰æ¢è¡Œç¬¦åˆ†å‰²ï¼‰
        print(f"âœ… æ‹‰å–æˆåŠŸ | åŸå§‹æ€»è¡Œæ•°: {raw_line}")
        return content, raw_line
    
    except Exception as e:
        # æ•è·æ‰€æœ‰å¼‚å¸¸ï¼ˆç½‘ç»œè¶…æ—¶ã€è¿æ¥å¤±è´¥ã€æœåŠ¡å™¨é”™è¯¯ç­‰ï¼‰ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯
        print(f"âŒ æ‹‰å–å¤±è´¥ | é”™è¯¯: {type(e).__name__} - {str(e)}")
        return "", 0


def count_rule_types(rule_list):
    """æŒ‰AGHè¯­æ³•ç»Ÿè®¡è§„åˆ™ç±»å‹ï¼Œç¡®ä¿ é»‘åå•+ç™½åå•+å…¶ä»–è§„åˆ™ = æ€»æœ‰æ•ˆè§„åˆ™æ•°
    AGHè¯­æ³•è§„åˆ™ï¼š@@å¼€å¤´=ç™½åå•ï¼Œ||å¼€å¤´=é»‘åå•ï¼Œå…¶ä½™å½’ä¸ºå…¶ä»–è§„åˆ™ï¼ˆæ­£åˆ™/IPæ®µç­‰ï¼‰
    å‚æ•°ï¼šrule_list - å¾…ç»Ÿè®¡çš„æœ‰æ•ˆè§„åˆ™åˆ—è¡¨ï¼ˆå·²è¿‡æ»¤ç©ºè¡Œ/æ³¨é‡Šè¡Œï¼‰
    è¿”å›ï¼šé»‘åå•æ•°é‡ã€ç™½åå•æ•°é‡ã€å…¶ä»–è§„åˆ™æ•°é‡
    """
    black, white, other = 0, 0, 0
    for r in rule_list:
        r = r.strip()  # å»é™¤è§„åˆ™å‰åç©ºæ ¼/æ¢è¡Œç¬¦ï¼Œé¿å…ç©ºå­—ç¬¦å½±å“åˆ¤æ–­
        if not r: continue  # è·³è¿‡ç©ºè¡Œï¼Œä¸å‚ä¸ç»Ÿè®¡
        
        if r.startswith("@@"):
            white += 1
        elif r.startswith("||"):
            black += 1
        else:
            other += 1  # æ­£åˆ™è¡¨è¾¾å¼ã€IPæ®µã€ç‰¹æ®Šè¯­æ³•è§„åˆ™ç­‰
    return black, white, other


def process_single_rule_source(url, source_name):
    """å¤„ç†å•ä¸ªè§„åˆ™æºå…¨æµç¨‹ï¼šæ‹‰å–â†’è¿‡æ»¤æ— æ•ˆè¡Œâ†’ç»Ÿè®¡ç±»å‹â†’æºå†…å»é‡
    å‚æ•°ï¼š
        url: è¿œç¨‹è§„åˆ™æºåœ°å€
        source_name: è§„åˆ™æºåç§°
    è¿”å›ï¼š
        æˆåŠŸï¼šè§„åˆ™æºç»Ÿè®¡ä¿¡æ¯ï¼ˆå­—å…¸ï¼‰ã€åŸå§‹æœ‰æ•ˆè§„åˆ™åˆ—è¡¨ã€æºå†…å»é‡åè§„åˆ™åˆ—è¡¨
        å¤±è´¥ï¼šç©ºå­—å…¸ã€ç©ºåˆ—è¡¨ã€ç©ºåˆ—è¡¨ï¼ˆæ‹‰å–å¤±è´¥æ—¶è¿”å›ï¼‰
    """
    # æ‹‰å–è¿œç¨‹è§„åˆ™å†…å®¹
    content, raw_line_count = fetch_remote_content(url, source_name)
    if not content:  # æ‹‰å–å¤±è´¥åˆ™ç›´æ¥è¿”å›ç©ºå€¼
        return {}, [], []
    
    # è¿‡æ»¤æ— æ•ˆè¡Œï¼šç©ºè¡Œã€ä»¥!/#/!#å¼€å¤´çš„æ³¨é‡Šè¡Œï¼ˆAGHæ³¨é‡Šè§„èŒƒä¸º!ï¼Œå…¼å®¹#æ³¨é‡Šï¼‰
    lines, valid, skip = content.splitlines(), [], 0
    for line in lines:
        line = line.strip()
        if not line or line.startswith(('!', '#', '!#')):
            skip += 1  # æ— æ•ˆè¡Œè®¡æ•°å™¨+1
            continue
        valid.append(line)  # æœ‰æ•ˆè§„åˆ™åŠ å…¥åˆ—è¡¨
    
    # ç»Ÿè®¡æœ‰æ•ˆè§„åˆ™æ€»æ•°+è§„åˆ™ç±»å‹ï¼Œæ‰§è¡Œæºå†…å»é‡ï¼ˆä¿æŒè§„åˆ™é¡ºåºï¼‰
    valid_cnt = len(valid)
    black, white, other = count_rule_types(valid)
    deduped = list(dict.fromkeys(valid))  # å­—å…¸å»é‡æ³•ï¼šä¿ç•™è§„åˆ™åŸå§‹é¡ºåº
    inner_dedup = valid_cnt - len(deduped)  # ç»Ÿè®¡æºå†…é‡å¤è§„åˆ™æ•°é‡
    
    # æ•´ç†å½“å‰è§„åˆ™æºçš„å…¨é‡ç»Ÿè®¡ä¿¡æ¯ï¼Œæ–¹ä¾¿åç»­å…¨å±€æ±‡æ€»
    stats = {
        "raw_line": raw_line_count,  # åŸå§‹æ€»è¡Œæ•°
        "skip": skip,                # è¿‡æ»¤çš„æ— æ•ˆè¡Œæ•°é‡
        "total_rule": valid_cnt,     # æœ‰æ•ˆè§„åˆ™æ€»æ•°
        "inner_dedup": inner_dedup,  # æºå†…å»é‡æ•°é‡
        "black": black,              # é»‘åå•è§„åˆ™æ•°
        "white": white,              # ç™½åå•è§„åˆ™æ•°
        "other": other               # å…¶ä»–è§„åˆ™æ•°
    }
    # æ‰“å°å½“å‰è§„åˆ™æºçš„ç»Ÿè®¡æ—¥å¿—ï¼Œæ–¹ä¾¿æŸ¥çœ‹å•æºå¤„ç†ç»“æœ
    print(f"ğŸ“Š ã€{source_name}ã€‘| æ€»è§„åˆ™: {valid_cnt}æ¡ | é»‘: {black} | ç™½: {white} | å…¶ä»–: {other}")
    return stats, valid, deduped


# â€”â€” ä¸»é€»è¾‘åŒº â€”â€”
def main():
    """è„šæœ¬æ ¸å¿ƒæ‰§è¡Œé€»è¾‘ï¼šæŒ‰æµç¨‹å®Œæˆå¤šè§„åˆ™æºçš„åˆå¹¶ã€å»é‡ã€ç»Ÿè®¡ã€æ–‡ä»¶ç”Ÿæˆ
    æ‰§è¡Œæ­¥éª¤ï¼šåˆå§‹åŒ–å®¹å™¨â†’å¤„ç†æ‰€æœ‰è§„åˆ™æºâ†’å…¨å±€è·¨æºå»é‡â†’ç”Ÿæˆå¤´éƒ¨æ³¨é‡Šâ†’å†™å…¥æ–‡ä»¶â†’æ‰“å°æœ€ç»ˆæ—¥å¿—
    """
    # åˆå§‹åŒ–æ•°æ®å­˜å‚¨å®¹å™¨ï¼Œç”¨äºä¿å­˜ç»Ÿè®¡ä¿¡æ¯å’Œè§„åˆ™å†…å®¹
    source_stats_list = []  # å­˜å‚¨æ¯ä¸ªè§„åˆ™æºçš„è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯ï¼ˆç”¨äºç”Ÿæˆè§„åˆ™æ–‡ä»¶æ³¨é‡Šï¼‰
    # å­˜å‚¨æ‰€æœ‰è§„åˆ™æºçš„å…¨å±€æ±‡æ€»ç»Ÿè®¡ä¿¡æ¯
    total_stats = {
        "raw_line":0, "skip":0, "total_rule":0, "inner_dedup":0,
        "total_black":0, "total_white":0, "total_other":0
    }
    all_deduped_rules = []  # å­˜å‚¨æ‰€æœ‰è§„åˆ™æºå»é‡åçš„è§„åˆ™ï¼Œç”¨äºåç»­å…¨å±€è·¨æºå»é‡


    # æ­¥éª¤1ï¼šéå†å¤„ç†æ‰€æœ‰è§„åˆ™æºï¼Œå®Œæˆæ‹‰å–ã€è¿‡æ»¤ã€ç»Ÿè®¡ã€æºå†…å»é‡ï¼Œå¹¶æ±‡æ€»æ•°æ®
    print("="*80 + "\nğŸ“¦ å¼€å§‹å¤„ç†ã€æ‰€æœ‰AGHè§„åˆ™æºã€‘\n" + "="*80)
    for idx, (url, name) in enumerate(zip(AGH_RULE_URLS, AGH_RULE_NAMES), 1):
        print(f"\nğŸ”¸ æ­£åœ¨å¤„ç†ç¬¬{idx}ä¸ªè§„åˆ™æº: {name}")
        stats, _, deduped = process_single_rule_source(url, name)
        # å°†å½“å‰è§„åˆ™æºçš„ç»Ÿè®¡ä¿¡æ¯åŠ å…¥åˆ—è¡¨ï¼Œåç»­ç”Ÿæˆæ³¨é‡Šä½¿ç”¨
        source_stats_list.append({"name": name, "url": url, **stats})
        
        # è‹¥å½“å‰è§„åˆ™æºå¤„ç†æˆåŠŸï¼ˆå»é‡åè§„åˆ™éç©ºï¼‰ï¼Œåˆ™æ±‡æ€»åˆ°å…¨å±€ç»Ÿè®¡
        if deduped:
            total_stats["raw_line"] += stats["raw_line"]
            total_stats["skip"] += stats["skip"]
            total_stats["total_rule"] += stats["total_rule"]
            total_stats["inner_dedup"] += stats["inner_dedup"]
            total_stats["total_black"] += stats["black"]
            total_stats["total_white"] += stats["white"]
            total_stats["total_other"] += stats["other"]
            all_deduped_rules.extend(deduped)  # åˆå¹¶æºå†…å»é‡åçš„è§„åˆ™åˆ°å…¨å±€åˆ—è¡¨


    # æ­¥éª¤2ï¼šå…¨å±€è·¨æºå»é‡ï¼Œè¿‡æ»¤ç©ºè¡Œï¼Œç»Ÿè®¡æœ€ç»ˆè§„åˆ™æ•°é‡å’Œç±»å‹
    all_deduped_rules = [r for r in list(dict.fromkeys(all_deduped_rules)) if r.strip()]
    final_total = len(all_deduped_rules)  # å…¨å±€å»é‡åçš„æœ€ç»ˆè§„åˆ™æ€»æ•°
    # ç»Ÿè®¡æœ€ç»ˆè§„åˆ™çš„ç±»å‹åˆ†å¸ƒ
    final_black, final_white, final_other = count_rule_types(all_deduped_rules)
    cross_dedup = total_stats["total_rule"] - final_total  # ç»Ÿè®¡è·¨æºé‡å¤è§„åˆ™æ•°é‡
    # ç»Ÿè®¡æ‰€æœ‰æºå†…å»é‡åçš„è§„åˆ™æ€»æ•°
    source_merged_total = total_stats["total_rule"] - total_stats["inner_dedup"]


    # æ­¥éª¤3ï¼šç”ŸæˆåŒ—äº¬æ—¶é—´ï¼Œæ„å»ºè§„åˆ™æ–‡ä»¶çš„å¤´éƒ¨æ³¨é‡Šï¼ˆå«ç»Ÿè®¡ä¿¡æ¯/è®¢é˜…åœ°å€/è§„åˆ™æºï¼‰
    beijing_time = datetime.now() + timedelta(hours=8)  # UTCæ—¶é—´+8å°æ—¶=åŒ—äº¬æ—¶é—´
    header = [
        f"# AGHè§„åˆ™åˆå¹¶ (å¤šæºå»é‡)",
        f"# ç”Ÿæˆæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰: {beijing_time.strftime('%Y-%m-%d %H:%M:%S')}",
        f"# è§„åˆ™æºåœ°å€ï¼š",
        f"#   1. {source_stats_list[0]['name']} è§„åˆ™ï¼š{source_stats_list[0]['url']}",
        f"#   2. {source_stats_list[1]['name']} è§„åˆ™ï¼š{source_stats_list[1]['url']}",
        f"#   3. æœ¬è§„åˆ™è®¢é˜…åœ°å€ï¼š{SUBSCRIBE_URL}",
        f"# ==============================================================================",
        f"# ã€å„è§„åˆ™æºå•ç‹¬ç»Ÿè®¡ã€‘",
        f"#   1. {source_stats_list[0]['name']} | æ€»è§„åˆ™æ•°ï¼š{source_stats_list[0]['total_rule']} æ¡ | é»‘åå•ï¼š{source_stats_list[0]['black']} æ¡ | ç™½åå•ï¼š{source_stats_list[0]['white']} æ¡ | å…¶ä»–è§„åˆ™ï¼š{source_stats_list[0]['other']} æ¡",
        f"#   2. {source_stats_list[1]['name']} | æ€»è§„åˆ™æ•°ï¼š{source_stats_list[1]['total_rule']} æ¡ | é»‘åå•ï¼š{source_stats_list[1]['black']} æ¡ | ç™½åå•ï¼š{source_stats_list[1]['white']} æ¡ | å…¶ä»–è§„åˆ™ï¼š{source_stats_list[1]['other']} æ¡",
        f"# ==============================================================================",
        f"# ã€è§„åˆ™æºæ±‡æ€»ç»Ÿè®¡ã€‘",
        f"# åŸå§‹æ€»è¡Œæ•°ï¼š{total_stats['raw_line']} æ¡ | è·³è¿‡æ— æ•ˆè¡Œï¼š{total_stats['skip']} æ¡",
        f"# è¿‡æ»¤æœ‰æ•ˆæ•°ï¼š{total_stats['total_rule']} æ¡ | æºå†…å»é‡æ•°ï¼š{total_stats['inner_dedup']} æ¡ | æºå†…åˆå¹¶å",
        f"# æ±‡æ€»è§„åˆ™ï¼šé»‘{total_stats['total_black']}æ¡ | ç™½{total_stats['total_white']}æ¡ | å…¶ä»–{total_stats['total_other']}æ¡ | æ€»è®¡{total_stats['total_black']+total_stats['total_white']+total_stats['total_other']}æ¡",
        f"# ==============================================================================",
        f"# ã€å…¨å±€åˆå¹¶ç»Ÿè®¡ã€‘",
        f"# æºå†…åˆå¹¶åæ€»æ•°ï¼š{source_merged_total}æ¡ | é»‘{total_stats['total_black']}æ¡ | ç™½{total_stats['total_white']}æ¡ | å…¶ä»–{total_stats['total_other']}æ¡",
        f"# è·¨æºé‡å¤å»é‡æ•°ï¼š{cross_dedup} æ¡ | æœ€ç»ˆå…¨å±€ä¿ç•™æ€»æ•°ï¼š{final_total} æ¡ | é»‘åå•{final_black}æ¡ | ç™½åå•{final_white}æ¡ | å…¶ä»–è§„åˆ™{final_other}æ¡",
        f"# ==============================================================================",
        f""  # ç©ºè¡Œåˆ†éš”ï¼šè®©å¤´éƒ¨æ³¨é‡Šå’Œå®é™…è§„åˆ™å†…å®¹åŒºåˆ†æ›´æ¸…æ™°
    ]


    # æ­¥éª¤4ï¼šå°†å¤´éƒ¨æ³¨é‡Šå’Œå…¨å±€å»é‡åçš„è§„åˆ™å†™å…¥æœ¬åœ°æ–‡ä»¶ï¼ˆUTF-8ç¼–ç é¿å…ä¸­æ–‡ä¹±ç ï¼‰
    with open(AGH_OUTPUT_FILE, 'w', encoding='utf-8') as f:
        # å°†æ³¨é‡Šåˆ—è¡¨å’Œè§„åˆ™åˆ—è¡¨åˆå¹¶ï¼Œç”¨æ¢è¡Œç¬¦è¿æ¥æˆå®Œæ•´å­—ç¬¦ä¸²åå†™å…¥
        f.write('\n'.join(header + all_deduped_rules))


    # æ­¥éª¤5ï¼šæ‰“å°æœ€ç»ˆæ‰§è¡Œç»“æœæ—¥å¿—ï¼ŒGH Actionsä¸­å¯æŸ¥çœ‹å®Œæ•´ç»Ÿè®¡æ•°æ®
    print("\n" + "="*80)
    print(f"âœ… AGHè§„åˆ™åˆå¹¶å»é‡å®Œæˆï¼ç”Ÿæˆæ–‡ä»¶ï¼š{AGH_OUTPUT_FILE}")
    print(f"ğŸ•’ ç”Ÿæˆæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š{beijing_time.strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"ğŸŒ è§„åˆ™å¼•ç”¨é“¾æ¥ï¼šhttps://raw.githubusercontent.com/ddcm1349/AGH/main/{AGH_OUTPUT_FILE}")
    print("="*80)
    print(f"ğŸ“Š ã€è§„åˆ™æºæ±‡æ€»ã€‘ | åŸå§‹æ€»è¡Œæ•°ï¼š{total_stats['raw_line']} æ¡ | è·³è¿‡æ— æ•ˆè¡Œï¼š{total_stats['skip']} æ¡")
    print(f"ğŸ“Š ã€æœ‰æ•ˆè§„åˆ™ç»Ÿè®¡ã€‘| æ€»æœ‰æ•ˆè§„åˆ™ï¼š{total_stats['total_rule']} æ¡ | æºå†…å»é‡ï¼š{total_stats['inner_dedup']} æ¡")
    print(f"ğŸ“Š ã€é»‘ç™½è§„åˆ™æ±‡æ€»ã€‘| æ€»é»‘åå•ï¼š{total_stats['total_black']} æ¡ | æ€»ç™½åå•ï¼š{total_stats['total_white']} æ¡ | å…¶ä»–è§„åˆ™ï¼š{total_stats['total_other']} æ¡")
    print(f"ğŸ“Š ã€å…¨å±€æœ€ç»ˆç»Ÿè®¡ã€‘| è·¨æºå»é‡æ•°ï¼š{cross_dedup} æ¡ | æœ€ç»ˆä¿ç•™æ€»æ•°ï¼š{final_total} æ¡")
    print(f"ğŸ“Š ã€æœ€ç»ˆé»‘ç™½åˆ†å¸ƒã€‘| é»‘åå•ï¼š{final_black} æ¡ | ç™½åå•ï¼š{final_white} æ¡ | å…¶ä»–è§„åˆ™ï¼š{final_other} æ¡")
    print("="*80)


# â€”â€” è„šæœ¬å…¥å£ â€”â€”
if __name__ == "__main__":
    # ä»…å½“ç›´æ¥è¿è¡Œæœ¬è„šæœ¬æ—¶ï¼Œæ‰æ‰§è¡Œä¸»é€»è¾‘ï¼ˆé¿å…è¢«ä½œä¸ºæ¨¡å—å¯¼å…¥æ—¶è‡ªåŠ¨æ‰§è¡Œï¼‰
    main()
