#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
AGH è§„åˆ™åˆå¹¶å»é‡å·¥å…· | æ·±åº¦è¿½è¸ªç‰ˆ
åŠŸèƒ½ï¼šé«˜æ€§èƒ½å»é‡ + è‡ªåŠ¨ç”Ÿæˆè¿‡æ»¤æ˜ç»†æ—¥å¿—
"""

import requests
import time
from datetime import datetime, timedelta
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

# --- åŸºç¡€é…ç½® ---
AGH_RULE_URLS = [
    "https://adrules.top/dns.txt",
    "https://anti-ad.net/easylist.txt",
    "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/AdGuard/Privacy/Privacy.txt",
]
AGH_RULE_NAMES = ["AdRules", "anti-ad", "Privacy"]
AGH_OUTPUT_FILE = "adguard_rules_qx.txt"
REMOVED_LOG_FILE = "removed_details.log"  # æ–°å¢ï¼šè¿‡æ»¤æ˜ç»†æ—¥å¿—
TIMEOUT = 30

def create_retry_session():
    session = requests.Session()
    retry = Retry(total=3, backoff_factor=1, status_forcelist=[429, 500, 502, 503, 504])
    session.mount("https://", HTTPAdapter(max_retries=retry))
    return session

def fetch_remote_content(url, source_name):
    start = time.time()
    try:
        headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0"}
        resp = create_retry_session().get(url, headers=headers, timeout=TIMEOUT)
        resp.raise_for_status()
        lines = resp.text.splitlines()
        print(f"  [âœ“] åŒæ­¥å®Œæˆ: {source_name:<10} | åŸå§‹è§„æ¨¡: {len(lines):>6} è¡Œ")
        return lines
    except Exception as e:
        print(f"  [âœ—] åŒæ­¥å¤±è´¥: {source_name:<10} | é”™è¯¯: {type(e).__name__}")
        return []

def apply_containment_dedup(rules, rule_type="è§„åˆ™"):
    """
    âš¡ é«˜æ€§èƒ½åŒ…å«å»é‡ç®—æ³•
    """
    if not rules:
        return [], []
    
    start_time = time.time()
    initial_count = len(rules)
    
    # é¢„å¤„ç†
    processed = []
    for r in rules:
        domain = r.split('$')[0].replace('||', '').replace('@@', '').replace('^', '').lower()
        if domain:
            processed.append((domain, r))
    
    # æŒ‰åŸŸåå±‚çº§æ’åº (a.com æ’åœ¨ b.a.com å‰é¢)
    processed.sort(key=lambda x: x[0].count('.'))
    
    final_rules = []
    seen_domains = set()
    removed_details = [] 
    
    for dom, original in processed:
        is_subdomain = False
        parts = dom.split('.')
        
        # é€çº§å‘ä¸ŠåŒ¹é…çˆ¶åŸŸé€»è¾‘
        for i in range(len(parts) - 1, 0, -1):
            parent = ".".join(parts[i:])
            if parent in seen_domains:
                is_subdomain = True
                removed_details.append(f"[{rule_type}] {original:<40} # è¢«çˆ¶åŸŸ [{parent}] è¦†ç›–")
                break
        
        if not is_subdomain:
            final_rules.append(original)
            seen_domains.add(dom)
    
    cost = time.time() - start_time
    print(f"  [âœ‚] {rule_type}è¿‡æ»¤: ç¼©å‡ {len(removed_details):>6} æ¡ | è€—æ—¶: {cost:.4f}s")
    return final_rules, removed_details

def main():
    main_start = time.time()
    all_raw_rules = []
    
    print("="*80)
    print(f"ğŸš€ AGH è§„åˆ™è‡ªåŠ¨åŒ–å¤„ç† | å¯åŠ¨æ—¶é—´: {datetime.now().strftime('%H:%M:%S')}")
    print("="*80)

    # 1. æ‹‰å–èµ„æº
    for url, name in zip(AGH_RULE_URLS, AGH_RULE_NAMES):
        raw_lines = fetch_remote_content(url, name)
        valid = [l.strip() for l in raw_lines if l.strip() and not l.startswith(('!', '#'))]
        all_raw_rules.extend(valid)

    # 2. å…¨å±€åŸºç¡€å»é‡
    unique_rules = list(dict.fromkeys(all_raw_rules))
    print(f"\n[é˜¶æ®µ 2] å…¨å±€åŸºç¡€å»é‡: å‡å°‘ {len(all_raw_rules) - len(unique_rules)} æ¡é‡å¤è¡Œ")

    # 3. åˆ†ç±»
    white_list = [r for r in unique_rules if r.startswith("@@")]
    black_list = [r for r in unique_rules if r.startswith("||")]
    other_list = [r for r in unique_rules if not (r.startswith("@@") or r.startswith("||"))]

    # 4. åŒ…å«å»é‡ç®—æ³•
    print(f"\n[é˜¶æ®µ 3] æ­£åœ¨åˆ†æåŸŸååŒ…å«å…³ç³»å¹¶è¿½è¸ªæ˜ç»†...")
    white_final, white_removed = apply_containment_dedup(white_list, "ç™½åå•")
    black_final, black_removed = apply_containment_dedup(black_list, "é»‘åå•")

    # 5. å†™å…¥è§„åˆ™æ–‡ä»¶
    final_output = white_final + black_final + other_list
    with open(AGH_OUTPUT_FILE, 'w', encoding='utf-8') as f:
        f.write('\n'.join(final_output))

    # 6. å†™å…¥è¿‡æ»¤æ˜ç»†æ—¥å¿—
    with open(REMOVED_LOG_FILE, 'w', encoding='utf-8') as f:
        f.write(f"# AGH è¿‡æ»¤æ˜ç»†æ—¥å¿— - ç”Ÿæˆäº {datetime.now()}\n")
        f.write(f"# æ€»è®¡è¿‡æ»¤: {len(white_removed) + len(black_removed)} æ¡\n")
        f.write("="*80 + "\n")
        f.write('\n'.join(white_removed + black_removed))

    print("\n" + "="*80)
    print(f"ğŸ† å¤„ç†å®Œæˆ!")
    print(f"   - æœ€ç»ˆæ–‡ä»¶: {AGH_OUTPUT_FILE} ({len(final_output)} æ¡)")
    print(f"   - è¿‡æ»¤æ—¥å¿—: {REMOVED_LOG_FILE} (è¯·å»æ­¤æ–‡ä»¶æŸ¥çœ‹è¢«åˆ è§„åˆ™)")
    print(f"   - æ€»è®¡ç”¨æ—¶: {time.time() - main_start:.2f} ç§’")
    print("="*80)

if __name__ == "__main__":
    main()
