#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
AGHè§„åˆ™åˆå¹¶å»é‡å·¥å…· | å…¨åŠŸèƒ½è‡ªåŠ¨åŒ–ç‰ˆ
ğŸ“Š ç»Ÿè®¡ç»´åº¦ï¼šé»‘/ç™½/å…¶ä»–è§„åˆ™ç²¾å‡†ç»Ÿè®¡ï¼Œæ€»æ•°å®Œå…¨åŒ¹é…
ğŸ“ è®¢é˜…é…ç½®ï¼šè§„åˆ™æº+è‡ªæœ‰è®¢é˜…åœ°å€ï¼Œæ³¨é‡Šåºå·3ä¸“å±å±•ç¤º
âœ‚ï¸ å»é‡é€»è¾‘ï¼šæºå†…å»é‡+è·¨æºå…¨å±€å»é‡+åŒ…å«å»é‡ï¼Œå…¨ç¨‹ä¿ç•™è§„åˆ™é¡ºåº
ğŸŒ ç½‘ç»œé€‚é…ï¼šå¸¦é‡è¯•æœºåˆ¶çš„ç½‘ç»œè¯·æ±‚ï¼ŒæŠ—æ³¢åŠ¨æ‹‰å–æ›´ç¨³å®š
ğŸ“ æ³¨é‡Šæ ¼å¼ï¼šè‡ªå®šä¹‰è§„èŒƒæ³¨é‡Šï¼Œè§„åˆ™æ–‡ä»¶å†…ç»Ÿè®¡ä¿¡æ¯å®Œæ•´
ğŸ–¥ï¸ æ—¥å¿—è¾“å‡ºï¼šGH Actionsæ—¥å¿—å®Œæ•´æ‰“å°ï¼Œå…³é”®ç»Ÿè®¡ä¸€é”®æŸ¥çœ‹
â° æ—¶é—´åŒæ­¥ï¼šç”Ÿæˆæ—¶é—´è‡ªåŠ¨è½¬æ¢åŒ—äº¬æ—¶é—´ï¼Œæ— æ—¶åŒºåå·®
"""


# â€”â€” æ¨¡å—å¯¼å…¥åŒº â€”â€”
import requests
from datetime import datetime, timedelta
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry


# â€”â€” æ ¸å¿ƒé…ç½®åŒº â€”â€”
AGH_RULE_URLS = [
    "https://adrules.top/dns.txt",
    "https://anti-ad.net/easylist.txt",
    "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/AdGuard/Privacy/Privacy.txt",
   # "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/AdGuard/Advertising/Advertising.txt"
]
AGH_RULE_NAMES = [
    "AdRules",
    "anti-ad",
    "Privacy",
    #"Advertising"
]
AGH_OUTPUT_FILE = "adguard_rules_qx.txt"
SUBSCRIBE_URL = "https://ddcm1349.github.io/AGH/adguard_rules_qx.txt"
TIMEOUT = 30


# â€”â€” å·¥å…·å‡½æ•°åŒº â€”â€”
def create_retry_session():
    session = requests.Session()
    retry = Retry(
        total=3,
        backoff_factor=1,
        status_forcelist=[429, 500, 502, 503, 504],
        allowed_methods=["GET"]
    )
    session.mount("https://", HTTPAdapter(max_retries=retry))
    session.mount("http://", HTTPAdapter(max_retries=retry))
    return session


def fetch_remote_content(url, source_name):
    try:
        print(f"\nğŸ“¥ æ‹‰å–ã€{source_name}ã€‘: {url}")
        headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0 Safari/537.36"}
        resp = create_retry_session().get(url, headers=headers, timeout=TIMEOUT)
        resp.raise_for_status()
        content = resp.text
        raw_line = len(content.splitlines())
        print(f"âœ… æ‹‰å–æˆåŠŸ | åŸå§‹æ€»è¡Œæ•°: {raw_line}")
        return content, raw_line
    except Exception as e:
        print(f"âŒ æ‹‰å–å¤±è´¥ | é”™è¯¯: {type(e).__name__} - {str(e)}")
        return "", 0


def count_rule_types(rule_list):
    black, white, other = 0, 0, 0
    for r in rule_list:
        r = r.strip()
        if not r: continue
        if r.startswith("@@"):
            white += 1
        elif r.startswith("||"):
            black += 1
        else:
            other += 1
    return black, white, other


def process_single_rule_source(url, source_name):
    content, raw_line_count = fetch_remote_content(url, source_name)
    if not content:
        return {}, [], []
    lines, valid, skip = content.splitlines(), [], 0
    for line in lines:
        line = line.strip()
        if not line or line.startswith(('!', '#', '!#')):
            skip += 1
            continue
        valid.append(line)
    valid_cnt = len(valid)
    black, white, other = count_rule_types(valid)
    deduped = list(dict.fromkeys(valid))
    inner_dedup = valid_cnt - len(deduped)
    stats = {
        "raw_line": raw_line_count,
        "skip": skip,
        "total_rule": valid_cnt,
        "inner_dedup": inner_dedup,
        "black": black,
        "white": white,
        "other": other
    }
    print(f"ğŸ“Š ã€{source_name}ã€‘| æ€»è§„åˆ™: {valid_cnt}æ¡ | é»‘: {black} | ç™½: {white} | å…¶ä»–: {other}")
    return stats, valid, deduped


# ============================================
# æ–°å¢ï¼šåŒ…å«å»é‡å‡½æ•°ï¼ˆç‰ˆæœ¬1ï¼šä»»æ„åç¼€åŒ¹é…ï¼‰
# ============================================
def apply_containment_dedup(rules):
    """
    å¯¹è§„åˆ™åˆ—è¡¨åº”ç”¨åŒ…å«å»é‡ï¼ˆåç¼€åŒ¹é…æ¨¡å¼ï¼‰ï¼š
    - å¦‚æœè§„åˆ™Açš„åŸŸåæ˜¯è§„åˆ™Bçš„åŸŸåçš„åç¼€ï¼Œåˆ™åˆ é™¤è§„åˆ™Bï¼ˆå› ä¸ºAå·²åŒ…å«Bï¼‰
    - ä¿ç•™ä¿®é¥°ç¬¦ï¼ˆ$åé¢çš„å†…å®¹ä¸å‚ä¸æ¯”è¾ƒï¼‰
    - ä¿æŒåŸå§‹é¡ºåº
    ä¾‹å¦‚ï¼š||b.com^ åŒ…å« ||a.b.com^ï¼Œåˆ é™¤ ||a.b.com^
    """
    if not rules:
        return []
    
    def extract_domain(rule):
        """æå–åŸŸåä¸»ä½“ï¼ˆç§»é™¤ä¿®é¥°ç¬¦å’ŒAGHå‰ç¼€ï¼‰"""
        # åˆ†ç¦»ä¿®é¥°ç¬¦
        main_part = rule.split('$')[0] if '$' in rule else rule
        # ç§»é™¤AGHå‰ç¼€
        if main_part.startswith('||') or main_part.startswith('@@'):
            main_part = main_part[2:]
        # ç§»é™¤ ^ ç»“å°¾
        if main_part.endswith('^'):
            main_part = main_part[:-1]
        return main_part.lower()
    
    # æ„å»ºè§„åˆ™ä¿¡æ¯åˆ—è¡¨
    rule_infos = []
    for rule in rules:
        domain = extract_domain(rule)
        rule_infos.append({
            'original': rule,
            'domain': domain
        })
    
    # åŒ…å«å»é‡ï¼šå¦‚æœçŸ­åŸŸåæ˜¯é•¿åŸŸåçš„åç¼€ï¼Œåˆ™ç§»é™¤é•¿åŸŸå
    to_remove = set()
    n = len(rule_infos)
    
    for i in range(n):
        if i in to_remove:
            continue
        domain_i = rule_infos[i]['domain']
        for j in range(i + 1, n):
            if j in to_remove:
                continue
            domain_j = rule_infos[j]['domain']
            
            # æ£€æŸ¥åç¼€å…³ç³»ï¼ˆç‰ˆæœ¬1ï¼šä»»æ„åç¼€åŒ¹é…ï¼‰
            # domain_i åŒ…å« domain_jï¼šdomain_j ä»¥ .domain_i ç»“å°¾ï¼Œæˆ–ä¸¤è€…ç›¸ç­‰
            if domain_j == domain_i:
                to_remove.add(j)  # å®Œå…¨é‡å¤
            elif domain_j.endswith('.' + domain_i):
                to_remove.add(j)  # j è¢« i åŒ…å«ï¼ˆiæ˜¯jçš„åç¼€ï¼‰
            elif domain_i.endswith('.' + domain_j):
                to_remove.add(i)  # i è¢« j åŒ…å«ï¼ˆjæ˜¯içš„åç¼€ï¼‰
                break  # i å·²è¢«ç§»é™¤ï¼Œæ— éœ€ç»§ç»­æ¯”è¾ƒ
    
    # ä¿ç•™æœªè¢«ç§»é™¤çš„è§„åˆ™ï¼Œä¿æŒåŸå§‹é¡ºåº
    result = [rule_infos[i]['original'] for i in range(n) if i not in to_remove]
    removed_count = len(to_remove)
    return result, removed_count


# â€”â€” ä¸»é€»è¾‘åŒº â€”â€”
def main():
    source_stats_list = []
    total_stats = {
        "raw_line":0, "skip":0, "total_rule":0, "inner_dedup":0,
        "total_black":0, "total_white":0, "total_other":0
    }
    all_deduped_rules = []


    print("="*80 + "\nğŸ“¦ å¼€å§‹å¤„ç†ã€æ‰€æœ‰AGHè§„åˆ™æºã€‘\n" + "="*80)
    for idx, (url, name) in enumerate(zip(AGH_RULE_URLS, AGH_RULE_NAMES), 1):
        print(f"\nğŸ”¸ æ­£åœ¨å¤„ç†ç¬¬{idx}ä¸ªè§„åˆ™æº: {name}")
        stats, _, deduped = process_single_rule_source(url, name)
        source_stats_list.append({"name": name, "url": url, **stats})
        if deduped:
            total_stats["raw_line"] += stats["raw_line"]
            total_stats["skip"] += stats["skip"]
            total_stats["total_rule"] += stats["total_rule"]
            total_stats["inner_dedup"] += stats["inner_dedup"]
            total_stats["total_black"] += stats["black"]
            total_stats["total_white"] += stats["white"]
            total_stats["total_other"] += stats["other"]
            all_deduped_rules.extend(deduped)


    # ============================================
    # æ–°å¢ï¼šåˆ†ç¦»é»‘ç™½åå•ï¼Œåˆ†åˆ«è¿›è¡ŒåŒ…å«å»é‡
    # ============================================
    # 1. åˆ†ç¦»é»‘ç™½åå•å’Œå…¶ä»–è§„åˆ™
    white_rules = [r for r in all_deduped_rules if r.startswith("@@")]
    black_rules = [r for r in all_deduped_rules if r.startswith("||")]
    other_rules = [r for r in all_deduped_rules if not r.startswith(("@@", "||"))]
    
    # 2. é»‘ç™½åå•å„è‡ªè¿›è¡ŒåŒ…å«å»é‡ï¼ˆäº’ä¸å¹²æ‰°ï¼‰
    white_rules_deduped, white_containment_dedup = apply_containment_dedup(white_rules)
    black_rules_deduped, black_containment_dedup = apply_containment_dedup(black_rules)
    # å…¶ä»–è§„åˆ™ä¸åšåŒ…å«å»é‡ï¼ˆä¿æŒåŸæ ·ï¼‰
    
    # 3. åˆå¹¶ï¼šç™½åå•åœ¨å‰ï¼Œé»‘åå•åœ¨åï¼Œå…¶ä»–è§„åˆ™æœ€å
    all_deduped_rules = white_rules_deduped + black_rules_deduped + other_rules


    # å…¨å±€è·¨æºå»é‡ç»Ÿè®¡ï¼ˆåŸºäºå·²æœ‰é€»è¾‘ï¼‰
    all_deduped_rules = [r for r in list(dict.fromkeys(all_deduped_rules)) if r.strip()]
    final_total = len(all_deduped_rules)
    final_black, final_white, final_other = count_rule_types(all_deduped_rules)
    cross_dedup = total_stats["total_rule"] - final_total
    source_merged_total = total_stats["total_rule"] - total_stats["inner_dedup"]


    beijing_time = datetime.now() + timedelta(hours=8)
    
    source_stats_lines = []
    for i, stat in enumerate(source_stats_list, 1):
        source_stats_lines.append(
            f"#   {i}. {stat['name']} | æ€»è§„åˆ™æ•°ï¼š{stat['total_rule']} æ¡ | "
            f"é»‘åå•ï¼š{stat['black']} æ¡ | ç™½åå•ï¼š{stat['white']} æ¡ | å…¶ä»–è§„åˆ™ï¼š{stat['other']} æ¡"
        )
    
    header = [
        f"# AGHè§„åˆ™åˆå¹¶ (å¤šæºå»é‡+åŒ…å«å»é‡)",
        f"# ç”Ÿæˆæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰: {beijing_time.strftime('%Y-%m-%d %H:%M:%S')}",
        f"# è®¢é˜…åœ°å€ï¼š{SUBSCRIBE_URL}",
        f"# ==============================================================================",
        f"# ã€å„è§„åˆ™æºå•ç‹¬ç»Ÿè®¡ã€‘",
        *source_stats_lines,
        f"# ==============================================================================",
        f"# ã€å…¨å±€åˆå¹¶ç»Ÿè®¡ã€‘",
        f"# åŸå§‹æ€»è¡Œæ•°ï¼š{total_stats['raw_line']} æ¡ | è·³è¿‡æ— æ•ˆè¡Œï¼š{total_stats['skip']} æ¡",
        f"# æºå†…åˆå¹¶åæ€»æ•°ï¼š{source_merged_total}æ¡ | é»‘{total_stats['total_black']}æ¡ | ç™½{total_stats['total_white']}æ¡ | å…¶ä»–{total_stats['total_other']}æ¡",
        f"# è·¨æºé‡å¤å»é‡æ•°ï¼š{cross_dedup} æ¡ | åŒ…å«å»é‡(ç™½)ï¼š{white_containment_dedup} æ¡ | åŒ…å«å»é‡(é»‘)ï¼š{black_containment_dedup} æ¡",
        f"# æœ€ç»ˆå…¨å±€ä¿ç•™æ€»æ•°ï¼š{final_total} æ¡ | é»‘åå•{final_black}æ¡ | ç™½åå•{final_white}æ¡ | å…¶ä»–è§„åˆ™{final_other}æ¡",
        f"# ==============================================================================",
        f""
    ]


    with open(AGH_OUTPUT_FILE, 'w', encoding='utf-8') as f:
        f.write('\n'.join(header + all_deduped_rules))


    print("\n" + "="*80)
    print(f"âœ… AGHè§„åˆ™åˆå¹¶å»é‡å®Œæˆï¼ç”Ÿæˆæ–‡ä»¶ï¼š{AGH_OUTPUT_FILE}")
    print(f"ğŸ•’ ç”Ÿæˆæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š{beijing_time.strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"ğŸŒ è§„åˆ™å¼•ç”¨é“¾æ¥ï¼šhttps://raw.githubusercontent.com/ddcm1349/AGH/main/{AGH_OUTPUT_FILE}")
    print("="*80)
    print(f"ğŸ“Š ã€è§„åˆ™æºæ±‡æ€»ã€‘ | åŸå§‹æ€»è¡Œæ•°ï¼š{total_stats['raw_line']} æ¡ | è·³è¿‡æ— æ•ˆè¡Œï¼š{total_stats['skip']} æ¡")
    print(f"ğŸ“Š ã€æœ‰æ•ˆè§„åˆ™ç»Ÿè®¡ã€‘| æ€»æœ‰æ•ˆè§„åˆ™ï¼š{total_stats['total_rule']} æ¡ | æºå†…å»é‡ï¼š{total_stats['inner_dedup']} æ¡")
    print(f"ğŸ“Š ã€é»‘ç™½è§„åˆ™æ±‡æ€»ã€‘| æ€»é»‘åå•ï¼š{total_stats['total_black']} æ¡ | æ€»ç™½åå•ï¼š{total_stats['total_white']} æ¡ | å…¶ä»–è§„åˆ™ï¼š{total_stats['total_other']} æ¡")
    print(f"ğŸ“Š ã€åŒ…å«å»é‡ç»Ÿè®¡ã€‘| ç™½åå•å»é‡ï¼š{white_containment_dedup} æ¡ | é»‘åå•å»é‡ï¼š{black_containment_dedup} æ¡")
    print(f"ğŸ“Š ã€å…¨å±€æœ€ç»ˆç»Ÿè®¡ã€‘| è·¨æºå»é‡æ•°ï¼š{cross_dedup} æ¡ | æœ€ç»ˆä¿ç•™æ€»æ•°ï¼š{final_total} æ¡")
    print(f"ğŸ“Š ã€æœ€ç»ˆé»‘ç™½åˆ†å¸ƒã€‘| é»‘åå•ï¼š{final_black} æ¡ | ç™½åå•ï¼š{final_white} æ¡ | å…¶ä»–è§„åˆ™ï¼š{final_other} æ¡")
    print("="*80)


if __name__ == "__main__":
    main()
