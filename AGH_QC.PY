#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
AGHè§„åˆ™åˆå¹¶å»é‡å·¥å…· | å…¨åŠŸèƒ½è‡ªåŠ¨åŒ–ç‰ˆ
"""


import requests
from datetime import datetime, timedelta
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry


AGH_RULE_URLS = [
    "https://adrules.top/dns.txt",
    "https://anti-ad.net/easylist.txt",
    "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/AdGuard/Privacy/Privacy.txt",
]
AGH_RULE_NAMES = [
    "AdRules",
    "anti-ad",
    "Privacy",
]
AGH_OUTPUT_FILE = "adguard_rules_qx.txt"
SUBSCRIBE_URL = "https://ddcm1349.github.io/AGH/adguard_rules_qx.txt"
TIMEOUT = 30


def create_retry_session():
    session = requests.Session()
    retry = Retry(
        total=3,
        backoff_factor=1,
        status_forcelist=[429, 500, 502, 503, 504],
        allowed_methods=["GET"]
    )
    session.mount("https://", HTTPAdapter(max_retries=retry))
    session.mount("http://", HTTPAdapter(max_retries=retry))
    return session


def fetch_remote_content(url, source_name):
    try:
        print(f"\nğŸ“¥ æ‹‰å–ã€{source_name}ã€‘: {url}")
        headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0 Safari/537.36"}
        resp = create_retry_session().get(url, headers=headers, timeout=TIMEOUT)
        resp.raise_for_status()
        content = resp.text
        raw_line = len(content.splitlines())
        print(f"âœ… æ‹‰å–æˆåŠŸ | åŸå§‹æ€»è¡Œæ•°: {raw_line}")
        return content, raw_line
    except Exception as e:
        print(f"âŒ æ‹‰å–å¤±è´¥ | é”™è¯¯: {type(e).__name__} - {str(e)}")
        return "", 0


def count_rule_types(rule_list):
    black, white, other = 0, 0, 0
    for r in rule_list:
        r = r.strip()
        if not r: continue
        if r.startswith("@@"):
            white += 1
        elif r.startswith("||"):
            black += 1
        else:
            other += 1
    return black, white, other


def process_single_rule_source(url, source_name):
    content, raw_line_count = fetch_remote_content(url, source_name)
    if not content:
        return {}, [], []
    lines, valid, skip = content.splitlines(), [], 0
    for line in lines:
        line = line.strip()
        if not line or line.startswith(('!', '#', '!#')):
            skip += 1
            continue
        valid.append(line)
    valid_cnt = len(valid)
    black, white, other = count_rule_types(valid)
    deduped = list(dict.fromkeys(valid))
    inner_dedup = valid_cnt - len(deduped)
    stats = {
        "raw_line": raw_line_count,
        "skip": skip,
        "total_rule": valid_cnt,
        "inner_dedup": inner_dedup,
        "black": black,
        "white": white,
        "other": other
    }
    print(f"ğŸ“Š ã€{source_name}ã€‘| æ€»è§„åˆ™: {valid_cnt}æ¡ | é»‘: {black} | ç™½: {white} | å…¶ä»–: {other}")
    return stats, valid, deduped


# ============================================
# æ–°å¢ï¼šåŒ…å«å»é‡å‡½æ•°
# ============================================
def apply_containment_dedup(rules):
    """
    å¯¹è§„åˆ™åˆ—è¡¨åº”ç”¨åŒ…å«å»é‡ï¼ˆåç¼€åŒ¹é…æ¨¡å¼ï¼‰
    """
    if not rules:
        return [], 0
    
    def extract_domain(rule):
        """æå–åŸŸåä¸»ä½“ï¼ˆç§»é™¤ä¿®é¥°ç¬¦å’ŒAGHå‰ç¼€ï¼‰"""
        main_part = rule.split('$')[0] if '$' in rule else rule
        if main_part.startswith('||') or main_part.startswith('@@'):
            main_part = main_part[2:]
        if main_part.endswith('^'):
            main_part = main_part[:-1]
        return main_part.lower()
    
    # æ„å»ºè§„åˆ™ä¿¡æ¯åˆ—è¡¨
    rule_infos = []
    for rule in rules:
        domain = extract_domain(rule)
        rule_infos.append({
            'original': rule,
            'domain': domain
        })
    
    # åŒ…å«å»é‡
    to_remove = set()
    n = len(rule_infos)
    
    for i in range(n):
        if i in to_remove:
            continue
        domain_i = rule_infos[i]['domain']
        for j in range(i + 1, n):
            if j in to_remove:
                continue
            domain_j = rule_infos[j]['domain']
            
            # æ£€æŸ¥åç¼€å…³ç³»
            if domain_j == domain_i:
                to_remove.add(j)
            elif domain_j.endswith('.' + domain_i):
                to_remove.add(j)
            elif domain_i.endswith('.' + domain_j):
                to_remove.add(i)
                break
    
    # ä¿ç•™æœªè¢«ç§»é™¤çš„è§„åˆ™ï¼Œä¿æŒåŸå§‹é¡ºåº
    result = [rule_infos[i]['original'] for i in range(n) if i not in to_remove]
    removed_count = len(to_remove)
    return result, removed_count


# â€”â€” ä¸»é€»è¾‘åŒº â€”â€”
def main():
    source_stats_list = []
    total_stats = {
        "raw_line":0, "skip":0, "total_rule":0, "inner_dedup":0,
        "total_black":0, "total_white":0, "total_other":0
    }
    all_rules = []  # æ”¶é›†æ‰€æœ‰è§„åˆ™ï¼ˆæœªå»é‡ï¼‰


    print("="*80 + "\nğŸ“¦ å¼€å§‹å¤„ç†ã€æ‰€æœ‰AGHè§„åˆ™æºã€‘\n" + "="*80)
    for idx, (url, name) in enumerate(zip(AGH_RULE_URLS, AGH_RULE_NAMES), 1):
        print(f"\nğŸ”¸ æ­£åœ¨å¤„ç†ç¬¬{idx}ä¸ªè§„åˆ™æº: {name}")
        stats, valid, deduped = process_single_rule_source(url, name)
        source_stats_list.append({"name": name, "url": url, **stats})
        if deduped:
            total_stats["raw_line"] += stats["raw_line"]
            total_stats["skip"] += stats["skip"]
            total_stats["total_rule"] += stats["total_rule"]
            total_stats["inner_dedup"] += stats["inner_dedup"]
            total_stats["total_black"] += stats["black"]
            total_stats["total_white"] += stats["white"]
            total_stats["total_other"] += stats["other"]
            all_rules.extend(deduped)  # ä½¿ç”¨æºå†…å»é‡åçš„è§„åˆ™


    # ============================================
    # æ­¥éª¤1ï¼šå…¨å±€å»é‡ï¼ˆè·¨æºå»é‡ï¼‰
    # ============================================
    all_rules_global_dedup = list(dict.fromkeys(all_rules))
    cross_dedup = len(all_rules) - len(all_rules_global_dedup)
    print(f"\nğŸ”„ å…¨å±€å»é‡: {len(all_rules)} â†’ {len(all_rules_global_dedup)} (å»é™¤ {cross_dedup} æ¡)")


    # ============================================
    # æ­¥éª¤2ï¼šåˆ†ç¦»é»‘ç™½åå•
    # ============================================
    white_rules = []
    black_rules = []
    other_rules = []
    
    for r in all_rules_global_dedup:
        if r.startswith("@@"):
            white_rules.append(r)
        elif r.startswith("||"):
            black_rules.append(r)
        else:
            other_rules.append(r)
    
    print(f"ğŸ“‹ åˆ†ç¦»ç»“æœ - ç™½:{len(white_rules)} é»‘:{len(black_rules)} å…¶ä»–:{len(other_rules)}")


    # ============================================
    # æ­¥éª¤3ï¼šå„è‡ªè¿›è¡ŒåŒ…å«å»é‡ï¼ˆäº’ä¸å¹²æ‰°ï¼‰
    # ============================================
    white_rules_final, white_containment_dedup = apply_containment_dedup(white_rules)
    black_rules_final, black_containment_dedup = apply_containment_dedup(black_rules)
    # å…¶ä»–è§„åˆ™ä¸åšåŒ…å«å»é‡
    
    print(f"âœ‚ï¸ åŒ…å«å»é‡ - ç™½:{len(white_rules)}â†’{len(white_rules_final)}(å»{white_containment_dedup}) é»‘:{len(black_rules)}â†’{len(black_rules_final)}(å»{black_containment_dedup})")


    # ============================================
    # æ­¥éª¤4ï¼šåˆå¹¶ - ç™½åå•åœ¨å‰ï¼Œé»‘åå•åœ¨åï¼Œå…¶ä»–è§„åˆ™æœ€å
    # ============================================
    final_rules = white_rules_final + black_rules_final + other_rules
    
    # ç»Ÿè®¡
    final_total = len(final_rules)
    final_black, final_white, final_other = count_rule_types(final_rules)
    source_merged_total = total_stats["total_rule"] - total_stats["inner_dedup"]


    beijing_time = datetime.now() + timedelta(hours=8)
    
    source_stats_lines = []
    for i, stat in enumerate(source_stats_list, 1):
        source_stats_lines.append(
            f"#   {i}. {stat['name']} | æ€»è§„åˆ™æ•°ï¼š{stat['total_rule']} æ¡ | "
            f"é»‘åå•ï¼š{stat['black']} æ¡ | ç™½åå•ï¼š{stat['white']} æ¡ | å…¶ä»–è§„åˆ™ï¼š{stat['other']} æ¡"
        )
    
    header = [
        f"# AGHè§„åˆ™åˆå¹¶ (å¤šæºå»é‡+åŒ…å«å»é‡)",
        f"# ç”Ÿæˆæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰: {beijing_time.strftime('%Y-%m-%d %H:%M:%S')}",
        f"# è®¢é˜…åœ°å€ï¼š{SUBSCRIBE_URL}",
        f"# ==============================================================================",
        f"# ã€å„è§„åˆ™æºå•ç‹¬ç»Ÿè®¡ã€‘",
        *source_stats_lines,
        f"# ==============================================================================",
        f"# ã€å…¨å±€åˆå¹¶ç»Ÿè®¡ã€‘",
        f"# åŸå§‹æ€»è¡Œæ•°ï¼š{total_stats['raw_line']} æ¡ | è·³è¿‡æ— æ•ˆè¡Œï¼š{total_stats['skip']} æ¡",
        f"# æºå†…åˆå¹¶åæ€»æ•°ï¼š{source_merged_total}æ¡ | é»‘{total_stats['total_black']}æ¡ | ç™½{total_stats['total_white']}æ¡ | å…¶ä»–{total_stats['total_other']}æ¡",
        f"# è·¨æºé‡å¤å»é‡æ•°ï¼š{cross_dedup} æ¡ | åŒ…å«å»é‡(ç™½)ï¼š{white_containment_dedup} æ¡ | åŒ…å«å»é‡(é»‘)ï¼š{black_containment_dedup} æ¡",
        f"# æœ€ç»ˆå…¨å±€ä¿ç•™æ€»æ•°ï¼š{final_total} æ¡ | é»‘åå•{final_black}æ¡ | ç™½åå•{final_white}æ¡ | å…¶ä»–è§„åˆ™{final_other}æ¡",
        f"# ==============================================================================",
        f""
    ]


    with open(AGH_OUTPUT_FILE, 'w', encoding='utf-8') as f:
        f.write('\n'.join(header + final_rules))


    print("\n" + "="*80)
    print(f"âœ… AGHè§„åˆ™åˆå¹¶å»é‡å®Œæˆï¼ç”Ÿæˆæ–‡ä»¶ï¼š{AGH_OUTPUT_FILE}")
    print(f"ğŸ•’ ç”Ÿæˆæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š{beijing_time.strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"ğŸŒ è§„åˆ™å¼•ç”¨é“¾æ¥ï¼šhttps://raw.githubusercontent.com/ddcm1349/AGH/main/{AGH_OUTPUT_FILE}")
    print("="*80)
    print(f"ğŸ“Š ã€è§„åˆ™æºæ±‡æ€»ã€‘ | åŸå§‹æ€»è¡Œæ•°ï¼š{total_stats['raw_line']} æ¡ | è·³è¿‡æ— æ•ˆè¡Œï¼š{total_stats['skip']} æ¡")
    print(f"ğŸ“Š ã€æœ‰æ•ˆè§„åˆ™ç»Ÿè®¡ã€‘| æ€»æœ‰æ•ˆè§„åˆ™ï¼š{total_stats['total_rule']} æ¡ | æºå†…å»é‡ï¼š{total_stats['inner_dedup']} æ¡")
    print(f"ğŸ“Š ã€é»‘ç™½è§„åˆ™æ±‡æ€»ã€‘| æ€»é»‘åå•ï¼š{total_stats['total_black']} æ¡ | æ€»ç™½åå•ï¼š{total_stats['total_white']} æ¡ | å…¶ä»–è§„åˆ™ï¼š{total_stats['total_other']} æ¡")
    print(f"ğŸ“Š ã€å…¨å±€å»é‡ç»Ÿè®¡ã€‘| è·¨æºå»é‡ï¼š{cross_dedup} æ¡")
    print(f"ğŸ“Š ã€åŒ…å«å»é‡ç»Ÿè®¡ã€‘| ç™½åå•å»é‡ï¼š{white_containment_dedup} æ¡ | é»‘åå•å»é‡ï¼š{black_containment_dedup} æ¡")
    print(f"ğŸ“Š ã€å…¨å±€æœ€ç»ˆç»Ÿè®¡ã€‘| æœ€ç»ˆä¿ç•™æ€»æ•°ï¼š{final_total} æ¡")
    print(f"ğŸ“Š ã€æœ€ç»ˆé»‘ç™½åˆ†å¸ƒã€‘| é»‘åå•ï¼š{final_black} æ¡ | ç™½åå•ï¼š{final_white} æ¡ | å…¶ä»–è§„åˆ™ï¼š{final_other} æ¡")
    print("="*80)


if __name__ == "__main__":
    main()
